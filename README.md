
# Bitrix Sitemap Queue

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è `sitemap.xml` –¥–ª—è Bitrix –Ω–∞ —Å–æ–±—ã—Ç–∏—è—Ö –∏–Ω—Ñ–æ–±–ª–æ–∫–æ–≤: –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å, –≤–æ—Ä–∫–µ—Ä –ø–∏–Ω–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–µ—Å—å —Å–Ω–µ–ø—à–æ—Ç –æ—á–µ—Ä–µ–¥–∏ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç—Ä–æ–≥–æ –≤ –æ–¥–Ω–æ–º —ç–∫–∑–µ–º–ø–ª—è—Ä–µ (—Ñ–∞–π–ª–æ–≤—ã–π –ª–æ–∫).

![diagram](docs/screenshots/flow.swg)

## –ó–∞—á–µ–º
- üîÑ –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø–æ —Ö—É–∫–∞–º (—ç–ª–µ–º–µ–Ω—Ç—ã/—Ä–∞–∑–¥–µ–ª—ã).
- üîí –ë–µ–∑ –≥–æ–Ω–æ–∫ –∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ ‚Äî –æ–¥–∏–Ω –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∑–∞ —Ä–∞–∑ (file lock).
- üóÇ –û—á–µ—Ä–µ–¥—å —Å–æ–±—ã—Ç–∏–π –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è, –∫–æ–∞–ª–µ—Å—Ü–∏—Ä—É–µ—Ç—Å—è.
- üìú –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏.
- ‚öôÔ∏è –ü–æ–¥—Ö–æ–¥–∏—Ç –∫–∞–∫ –¥–ª—è –ø–æ–ª–Ω–æ–π, —Ç–∞–∫ –∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–π —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

---

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–•—É–∫–∏** (`init.php` ‚Üí `sitemap_hooks.php`) –ª–æ–≤—è—Ç —Å–æ–±—ã—Ç–∏—è Bitrix (`OnAfterIBlockElement*`, `OnAfterIBlockSection*`), –∫–ª–∞–¥—É—Ç –∑–∞–ø–∏—Å–∏ –≤ –æ—á–µ—Ä–µ–¥—å `local/var/sitemap-queue.json` –∏ ¬´–ø–∏–Ω–∞—é—Ç¬ª –≤–æ—Ä–∫–µ—Ä –ø–æ HTTPS.
2. **–í–æ—Ä–∫–µ—Ä** (`sitemap_worker.php`) –≤—ã–∑—ã–≤–∞–µ—Ç `gen-site.php` –∏ —Å—Ä–∞–∑—É –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–∞–±–æ—Ç—É (–∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç `200 OK` –º–≥–Ω–æ–≤–µ–Ω–Ω–æ).
3. **–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä** (`gen-site.php`) —Å–∞–º:
   - —Å—Ç–∞–≤–∏—Ç –ª–æ–∫ –Ω–∞ 15 –º–∏–Ω—É—Ç (`local/var/sitemap.lock`);
   - —á–∏—Ç–∞–µ—Ç **–≤—Å—é** –æ—á–µ—Ä–µ–¥—å ‚Üí **–æ—á–∏—â–∞–µ—Ç** –µ—ë ‚Üí –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—é;
   - –ø–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å–Ω–∏–º–∞–µ—Ç –ª–æ–∫;
   - –µ—Å–ª–∏ –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –Ω–∞–∫–æ–ø–∏–ª–æ—Å—å –Ω–æ–≤–æ–µ ‚Äî —Å–∞–º ¬´–ø–∏–Ω–∞–µ—Ç¬ª –≤–æ—Ä–∫–µ—Ä –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —Ü–∏–∫–ª.

> –†–∞–Ω–Ω–∏–π –æ—Ç–≤–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ `fastcgi_finish_request()`, —á—Ç–æ–±—ã –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –Ω–µ —Ä–µ–∑–∞–ª –¥–æ–ª–≥—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–æ —Ç–∞–π–º–∞—É—Ç—É.

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1) –§–∞–π–ª—ã
–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ –ø—Ä–æ–µ–∫—Ç:

```

/local/tools/
sitemap\_hooks.php
sitemap\_worker.php
gen-site.php

/local/php\_interface/init.php  (–¥–æ–±–∞–≤—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏)

````

### 2) –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ `init.php`

```php
<?php
use Bitrix\Main\Loader;
Loader::includeModule('iblock');

AddEventHandler('iblock', 'OnAfterIBlockElementAdd',    ['Enisey\\Sitemap\\Hooks','onElementChange']);
AddEventHandler('iblock', 'OnAfterIBlockElementUpdate', ['Enisey\\Sitemap\\Hooks','onElementChange']);
AddEventHandler('iblock', 'OnAfterIBlockElementDelete', ['Enisey\\Sitemap\\Hooks','onElementDelete']);

AddEventHandler('iblock', 'OnAfterIBlockSectionAdd',    ['Enisey\\Sitemap\\Hooks','onSectionChange']);
AddEventHandler('iblock', 'OnAfterIBlockSectionUpdate', ['Enisey\\Sitemap\\Hooks','onSectionChange']);
AddEventHandler('iblock', 'OnAfterIBlockSectionDelete', ['Enisey\\Sitemap\\Hooks','onSectionDelete']);

require_once $_SERVER['DOCUMENT_ROOT'] . '/local/tools/sitemap_hooks.php';
````

### 3) –ü–∞–ø–∫–∞ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö

```bash
mkdir -p local/var
chmod 775 local/var
```

### 4) –°–µ–∫—Ä–µ—Ç—ã –∏ –¥–æ–º–µ–Ω

* –í `local/tools/sitemap_hooks.php` –∏ `local/tools/sitemap_worker.php` —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ **–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π** `SECRET`.
* –í—ã–∑–æ–≤—ã –ø–æ HTTPS –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ –ø—Ä–æ–¥-–¥–æ–º–µ–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `enisey-m.ru`). –ü–æ–º–µ–Ω—è–π—Ç–µ –Ω–∞ —Å–≤–æ–π –¥–æ–º–µ–Ω –≤ –æ–±–æ–∏—Ö —Ñ–∞–π–ª–∞—Ö.

### 5) –ü—Ä–æ–≤–µ—Ä–∫–∞

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ/–æ–±–Ω–æ–≤–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç –∏–Ω—Ñ–æ–±–ª–æ–∫–∞ ‚Äî –≤ `local/var/sitemap.log` –ø–æ—è–≤—è—Ç—Å—è —Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞:

```
[YYYY-mm-dd HH:MM:SS] enqueue element upsert id=123
[YYYY-mm-dd HH:MM:SS] kick worker
[YYYY-mm-dd HH:MM:SS] GEN: lock set for 15 minutes
[YYYY-mm-dd HH:MM:SS] GEN: snapshot size=1
[YYYY-mm-dd HH:MM:SS] GEN: lock released
```

---

## –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è

* **–ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç vs —Ç–æ—á–µ—á–Ω—ã–π**
  –í `gen-site.php` –º–æ–∂–µ—Ç–µ:

    * –≤—Å–µ–≥–¥–∞ –¥–µ–ª–∞—Ç—å –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç;
    * –ª–∏–±–æ —Ä–∞–∑–±–∏—Ä–∞—Ç—å `$GLOBALS['SITEMAP_QUEUE_SNAPSHOT']` –∏ –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ—á–µ—á–Ω–æ.

* **–ê–Ω—Ç–∏–¥—Ä–µ–±–µ–∑–≥ –ø–∏–Ω–∫–∞**
  –í `sitemap_hooks.php` —É–∂–µ –≤—Å—Ç—Ä–æ–µ–Ω —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥ (–Ω–µ —á–∞—â–µ 1 —Ä–∞–∑–∞ –≤ 3 —Å–µ–∫), –∏ –µ—Å–ª–∏ –ª–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω ‚Äî —Ö—É–∫–∏ —Ç–æ–ª—å–∫–æ –∫–æ–ø—è—Ç –æ—á–µ—Ä–µ–¥—å.

* **Cron-—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)**
  –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–∏–Ωutely-–ø–∏–Ω–æ–∫ –≤–æ—Ä–∫–µ—Ä–∞:

  ```bash
  * * * * * /usr/bin/php /var/www/<site>/local/tools/sitemap_worker.php > /dev/null 2>&1
  ```

  –î—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–µ –±—É–¥–µ—Ç: –ª–æ–∫ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫.

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
.
‚îú‚îÄ‚îÄ local
‚îÇ   ‚îú‚îÄ‚îÄ php_interface
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ init.php
‚îÇ   ‚îî‚îÄ‚îÄ tools
‚îÇ       ‚îú‚îÄ‚îÄ gen-site.php
‚îÇ       ‚îú‚îÄ‚îÄ sitemap_hooks.php
‚îÇ       ‚îî‚îÄ‚îÄ sitemap_worker.php
‚îú‚îÄ‚îÄ local
‚îÇ   ‚îî‚îÄ‚îÄ var
‚îÇ       ‚îú‚îÄ‚îÄ sitemap-queue.json
‚îÇ       ‚îú‚îÄ‚îÄ sitemap.lock
‚îÇ       ‚îî‚îÄ‚îÄ sitemap.log
‚îú‚îÄ‚îÄ docs
‚îÇ   ‚îî‚îÄ‚îÄ screenshots
‚îÇ       ‚îú‚îÄ‚îÄ flow.png
‚îÇ       ‚îî‚îÄ‚îÄ logs.png
‚îî‚îÄ‚îÄ examples
    ‚îî‚îÄ‚îÄ logs
        ‚îî‚îÄ‚îÄ sitemap.log
```

---

## –¢–∏–ø–æ–≤—ã–µ –ª–æ–≥–∏

### –£—Å–ø–µ—à–Ω—ã–π —Ü–∏–∫–ª + –ø–æ–≤—Ç–æ—Ä–Ω—ã–π —Å—Ç–∞—Ä—Ç

```
[03:55:02] enqueue element upsert id=16587
[03:55:02] kick worker
[03:55:02] GEN: lock set for 15 minutes
[03:55:02] GEN: snapshot size=1
... (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è) ...
[04:06:11] GEN: lock released
[04:06:11] GEN: queue not empty after run, re-kick worker
[04:06:12] GEN: lock set for 15 minutes
[04:06:12] GEN: snapshot size=1
```

### –í–æ –≤—Ä–µ–º—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ª–æ–∫–∞

```
[03:55:20] enqueue element delete id=16587
# —Ö—É–∫–∏ –Ω–µ –ø–∏–Ω–∞—é—Ç –≤–æ—Ä–∫–µ—Ä (–ª–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω), —Å–æ–±—ã—Ç–∏–µ –∫–æ–ø–∏—Ç—Å—è
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

* –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä (`gen-site.php`) –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ –≤–µ–±—É —Ç—Ä–µ–±—É–µ—Ç `?token=...`. –•—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏–ª–∏ –º–µ–Ω—è–π—Ç–µ –ø–æ –¥–µ–ø–ª–æ—é.
* –í–æ—Ä–∫–µ—Ä –≤—ã–∑—ã–≤–∞–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω, —Å –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–≥–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π SSL –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ (–º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –æ–±—Ä–∞—Ç–Ω–æ).
* –õ–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π/URL, –µ—Å–ª–∏ —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ.

---

## Troubleshooting

* **–í –ª–æ–≥–∞—Ö `errno=28 timeout` —É –≤–æ—Ä–∫–µ—Ä–∞** ‚Äî –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç; –≤–æ—Ä–∫–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∂–¥–∞—Ç—å –Ω–µ–¥–æ–ª–≥–æ, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å–æ—Ä—è—Ç—å –ø—É–ª PHP-FPM.
* **`Class "Bitrix\Main\Loader" not found` –≤ gen-site.php** ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–≤–µ—Ä—Ö—É `gen-site.php` –µ—Å—Ç—å –±—É—Ç—Å—Ç—Ä–∞–ø Bitrix (`prolog_before.php`).
* **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç** ‚Äî —Å–º–æ—Ç—Ä–∏—Ç–µ `sitemap.log`:

    * –Ω–µ—Ç —Å—Ç—Ä–æ–∫ `GEN: lock set` ‚Üí –≤–æ—Ä–∫–µ—Ä –Ω–µ –¥–æ—Å—Ç—É—á–∞–ª—Å—è –¥–æ –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ (–¥–æ–º–µ–Ω/SSL/—Ñ–∞–µ—Ä–≤–æ–ª).
    * `GEN: snapshot size=0` –∏ –ø—Ä–∏ —ç—Ç–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—ã–ª–∏ ‚Üí –æ—á–µ—Ä–µ–¥—å –Ω–µ –ø–∏—à–µ—Ç—Å—è (–ø—Ä–∞–≤–∞ –Ω–∞ `local/var`).

---

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License.

````

---

## –ü—Ä–∏–º–µ—Ä—ã –∏ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –¥–ª—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

### `examples/logs/sitemap.log`
```text
[2025-08-16 03:55:02] enqueue element upsert id=16587
[2025-08-16 03:55:02] kick worker
[2025-08-16 03:55:02] GEN: lock set for 15 minutes
[2025-08-16 03:55:02] GEN: snapshot size=1
[2025-08-16 04:06:11] GEN: lock released
[2025-08-16 04:06:11] GEN: queue not empty after run, re-kick worker
[2025-08-16 04:06:12] GEN: lock set for 15 minutes
[2025-08-16 04:06:12] GEN: snapshot size=1
````

### `docs/screenshots/flow.svg`